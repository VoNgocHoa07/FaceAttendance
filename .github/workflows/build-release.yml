name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install numpy pandas opencv-python-headless PySide6 openpyxl mediapipe face_recognition pyinstaller
      
      - name: Build with PyInstaller
        run: |
          pyinstaller --noconfirm --onedir --windowed `
            --name "FaceAttendance" `
            --add-data "Logo;Logo" `
            --hidden-import "PySide6.QtCore" `
            --hidden-import "PySide6.QtGui" `
            --hidden-import "PySide6.QtWidgets" `
            --hidden-import "cv2" `
            --hidden-import "mediapipe" `
            --hidden-import "face_recognition" `
            --hidden-import "dlib" `
            --hidden-import "numpy" `
            --hidden-import "pandas" `
            --hidden-import "openpyxl" `
            --collect-all "mediapipe" `
            --collect-all "face_recognition" `
            app_main.py
      
      - name: Create directories
        run: |
          New-Item -ItemType Directory -Force -Path "dist\FaceAttendance\known_faces"
          New-Item -ItemType Directory -Force -Path "dist\FaceAttendance\attendance_records"
      
      - name: Zip Windows build
        run: |
          Compress-Archive -Path "dist\FaceAttendance\*" -DestinationPath "FaceAttendance_Windows.zip"
      
      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: FaceAttendance_Windows
          path: FaceAttendance_Windows.zip

  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libxcb-xinerama0 libxcb-cursor0 libgl1-mesa-glx \
            libxkbcommon-x11-0 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 \
            libxcb-render-util0 libegl1 libxcb-shape0
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install numpy pandas opencv-python-headless PySide6 openpyxl mediapipe face_recognition pyinstaller
      
      - name: Build with PyInstaller
        run: |
          pyinstaller --noconfirm --onedir \
            --name "FaceAttendance" \
            --add-data "Logo:Logo" \
            --hidden-import "PySide6.QtCore" \
            --hidden-import "PySide6.QtGui" \
            --hidden-import "PySide6.QtWidgets" \
            --hidden-import "cv2" \
            --hidden-import "mediapipe" \
            --hidden-import "face_recognition" \
            --hidden-import "dlib" \
            --hidden-import "numpy" \
            --hidden-import "pandas" \
            --hidden-import "openpyxl" \
            --collect-all "mediapipe" \
            --collect-all "face_recognition" \
            app_main.py
      
      - name: Create directories and run script
        run: |
          mkdir -p dist/FaceAttendance/known_faces
          mkdir -p dist/FaceAttendance/attendance_records
          echo '#!/bin/bash' > dist/FaceAttendance/run.sh
          echo 'cd "$(dirname "$0")"' >> dist/FaceAttendance/run.sh
          echo './FaceAttendance' >> dist/FaceAttendance/run.sh
          chmod +x dist/FaceAttendance/run.sh
          chmod +x dist/FaceAttendance/FaceAttendance
      
      - name: Tar Linux build
        run: |
          cd dist
          tar -czvf ../FaceAttendance_Linux.tar.gz FaceAttendance/
      
      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: FaceAttendance_Linux
          path: FaceAttendance_Linux.tar.gz

  release:
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: FaceAttendance_Windows
      
      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: FaceAttendance_Linux
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            FaceAttendance_Windows.zip
            FaceAttendance_Linux.tar.gz
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
