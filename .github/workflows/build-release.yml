name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pip\Cache
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          
      - name: Install Visual C++ Build Tools
        run: |
          choco install visualstudio2022-workload-vctools -y
        shell: cmd
          
      - name: Install CMake
        run: |
          choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System' -y
        shell: cmd
        
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip wheel setuptools
          pip install cmake
          pip install dlib --verbose
          pip install -r requirements.txt
          pip install pyinstaller
          
      - name: Build executable
        run: |
          python -m PyInstaller FaceAttendance.spec --clean
          
      - name: Create distribution folder
        run: |
          mkdir dist\FaceAttendance-Windows
          copy dist\FaceAttendance.exe dist\FaceAttendance-Windows\
          mkdir dist\FaceAttendance-Windows\known_faces
          mkdir dist\FaceAttendance-Windows\attendance_records
          echo {} > dist\FaceAttendance-Windows\settings.json
          
      - name: Create ZIP
        run: |
          cd dist
          Compress-Archive -Path FaceAttendance-Windows -DestinationPath FaceAttendance-Windows.zip
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: FaceAttendance-Windows
          path: dist/FaceAttendance-Windows.zip

  build-macos:
    runs-on: macos-13
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          
      - name: Install system dependencies
        run: |
          brew install cmake
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip wheel setuptools
          pip install cmake
          pip install dlib
          pip install -r requirements.txt
          pip install pyinstaller
          
      - name: Build app
        run: |
          python -m PyInstaller FaceAttendance.spec --clean
          
      - name: Create distribution
        run: |
          mkdir -p dist/FaceAttendance-macOS
          cp -r dist/FaceAttendance.app dist/FaceAttendance-macOS/
          mkdir -p dist/FaceAttendance-macOS/known_faces
          mkdir -p dist/FaceAttendance-macOS/attendance_records
          echo '{}' > dist/FaceAttendance-macOS/settings.json
          
      - name: Create ZIP
        run: |
          cd dist
          zip -r FaceAttendance-macOS.zip FaceAttendance-macOS
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: FaceAttendance-macOS
          path: dist/FaceAttendance-macOS.zip

  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential libopenblas-dev liblapack-dev
          sudo apt-get install -y libxcb-xinerama0 libxkbcommon-x11-0 libxcb-cursor0
          sudo apt-get install -y libegl1 libgl1-mesa-glx
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip wheel setuptools
          pip install cmake
          pip install dlib
          pip install -r requirements.txt
          pip install pyinstaller
          
      - name: Build executable
        run: |
          python -m PyInstaller FaceAttendance.spec --clean
          
      - name: Create distribution
        run: |
          mkdir -p dist/FaceAttendance-Linux
          cp dist/FaceAttendance dist/FaceAttendance-Linux/
          chmod +x dist/FaceAttendance-Linux/FaceAttendance
          mkdir -p dist/FaceAttendance-Linux/known_faces
          mkdir -p dist/FaceAttendance-Linux/attendance_records
          echo '{}' > dist/FaceAttendance-Linux/settings.json
          # Create launcher script
          cat > dist/FaceAttendance-Linux/start.sh << 'EOF'
          #!/bin/bash
          cd "$(dirname "$0")"
          ./FaceAttendance
          EOF
          chmod +x dist/FaceAttendance-Linux/start.sh
          
      - name: Create tarball
        run: |
          cd dist
          tar -czvf FaceAttendance-Linux.tar.gz FaceAttendance-Linux
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: FaceAttendance-Linux
          path: dist/FaceAttendance-Linux.tar.gz

  release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          
      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Face Attendance v${{ steps.version.outputs.version }}
          body: |
            ## Face Recognition Attendance System v${{ steps.version.outputs.version }}
            
            ### Downloads
            - **Windows**: `FaceAttendance-Windows.zip` - Extract and run `FaceAttendance.exe`
            - **macOS**: `FaceAttendance-macOS.zip` - Extract and run `FaceAttendance.app`
            - **Linux**: `FaceAttendance-Linux.tar.gz` - Extract and run `./start.sh`
            
            ### First Time Setup
            1. Download the file for your operating system
            2. Extract the archive
            3. Run the application
            4. Add people using the "Add Person" button
            5. Start taking attendance!
            
            ### Notes
            - Camera access is required
            - `known_faces/` folder stores registered faces
            - `attendance_records/` folder stores attendance data
          files: |
            artifacts/FaceAttendance-Windows/FaceAttendance-Windows.zip
            artifacts/FaceAttendance-macOS/FaceAttendance-macOS.zip
            artifacts/FaceAttendance-Linux/FaceAttendance-Linux.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
